<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¿«å–æ¸¬è©¦å·¥å…· - Cache Test</title>
  <style>
    body {
      font-family: 'Microsoft JhengHei', sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    .container {
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    }

    h1 {
      color: #667eea;
      border-bottom: 3px solid #667eea;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }

    h2 {
      color: #764ba2;
      margin-top: 30px;
      border-left: 4px solid #764ba2;
      padding-left: 10px;
    }

    .test-section {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      border: 2px solid #e9ecef;
    }

    .status {
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      font-weight: bold;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .status.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      margin: 5px;
      transition: transform 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    .info-box {
      background: #e7f3ff;
      border-left: 4px solid #2196F3;
      padding: 15px;
      margin: 15px 0;
      border-radius: 4px;
    }

    .result {
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 15px;
      margin: 10px 0;
      font-family: 'Courier New', monospace;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    th {
      background: #667eea;
      color: white;
    }

    tr:hover {
      background: #f5f5f5;
    }

    .cache-indicator {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }

    .from-cache {
      background: #ff6b6b;
      color: white;
    }

    .from-server {
      background: #51cf66;
      color: white;
    }

    .code {
      background: #f4f4f4;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      color: #e83e8c;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” å¿«å–æ¸¬è©¦å·¥å…·</h1>
    <div class="info-box">
      <strong>ç”¨é€”ï¼š</strong>æ¸¬è©¦ JSON æª”æ¡ˆæ˜¯å¦è¢«ç€è¦½å™¨å¿«å–ï¼Œé©—è­‰é˜²å¿«å–åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œ
    </div>

    <!-- æ¸¬è©¦ 1ï¼šåŸºæœ¬è¼‰å…¥æ¸¬è©¦ -->
    <div class="test-section">
      <h2>æ¸¬è©¦ 1ï¼šåŸºæœ¬è¼‰å…¥æ¸¬è©¦</h2>
      <p>æ¸¬è©¦èƒ½å¦è¼‰å…¥ JSON æª”æ¡ˆï¼Œæª¢æŸ¥æ˜¯å¦å¾å¿«å–è¼‰å…¥</p>
      
      <button onclick="testBasicLoad()">ğŸš€ é–‹å§‹æ¸¬è©¦</button>
      <button onclick="clearResults()">ğŸ—‘ï¸ æ¸…é™¤çµæœ</button>
      
      <div id="basic-result"></div>
    </div>

    <!-- æ¸¬è©¦ 2ï¼šé˜²å¿«å–åŠŸèƒ½æ¸¬è©¦ -->
    <div class="test-section">
      <h2>æ¸¬è©¦ 2ï¼šé˜²å¿«å–åŠŸèƒ½æ¸¬è©¦ï¼ˆThemeLoaderï¼‰</h2>
      <p>æ¸¬è©¦ ThemeLoader çš„é˜²å¿«å–åŠŸèƒ½</p>
      
      <label>
        <input type="checkbox" id="enableCache" onchange="updateCacheMode()">
        å•Ÿç”¨å¿«å–ï¼ˆå‹¾é¸ = ç™¼å¸ƒæ¨¡å¼ï¼Œä¸å‹¾é¸ = é–‹ç™¼æ¨¡å¼ï¼‰
      </label>
      
      <br><br>
      
      <button onclick="testThemeLoader()">ğŸ¨ æ¸¬è©¦ ThemeLoader</button>
      
      <div id="loader-result"></div>
    </div>

    <!-- æ¸¬è©¦ 3ï¼šå¤šæ¬¡è¼‰å…¥æ¯”è¼ƒ -->
    <div class="test-section">
      <h2>æ¸¬è©¦ 3ï¼šå¤šæ¬¡è¼‰å…¥æ¯”è¼ƒ</h2>
      <p>é€£çºŒè¼‰å…¥ 5 æ¬¡ï¼Œæ¯”è¼ƒæ¯æ¬¡çš„è¼‰å…¥æ™‚é–“å’Œä¾†æº</p>
      
      <button onclick="testMultipleLoads()">ğŸ”„ é–‹å§‹æ¸¬è©¦ï¼ˆé€£çºŒ 5 æ¬¡ï¼‰</button>
      
      <div id="multiple-result"></div>
    </div>

    <!-- æ•™å­¸å€ -->
    <div class="test-section">
      <h2>ğŸ“š å¦‚ä½•ä½¿ç”¨æ¸¬è©¦çµæœ</h2>
      
      <h3>âœ… æ­£å¸¸æƒ…æ³ï¼ˆé˜²å¿«å–æˆåŠŸï¼‰</h3>
      <ul>
        <li>æ¯æ¬¡è¼‰å…¥éƒ½é¡¯ç¤º <span class="cache-indicator from-server">from server</span></li>
        <li>æª”æ¡ˆå¤§å°ä¿æŒä¸€è‡´</li>
        <li>è¼‰å…¥æ™‚é–“ç•¥æœ‰ä¸åŒ</li>
        <li>ç‹€æ…‹ç¢¼éƒ½æ˜¯ 200 OK</li>
      </ul>

      <h3>âŒ ç•°å¸¸æƒ…æ³ï¼ˆå¿«å–å•é¡Œï¼‰</h3>
      <ul>
        <li>é¡¯ç¤º <span class="cache-indicator from-cache">from disk cache</span> æˆ– <span class="cache-indicator from-cache">from memory cache</span></li>
        <li>è¼‰å…¥æ™‚é–“å›ºå®šç‚º 0 ms</li>
        <li>æ”¹äº†æª”æ¡ˆä½†çµæœæ²’è®Š</li>
      </ul>

      <h3>ğŸ”§ è§£æ±ºæ–¹æ³•</h3>
      <ol>
        <li>ç¢ºèª <span class="code">enableCache = false</span> åœ¨ ThemeLoader ä¸­</li>
        <li>æª¢æŸ¥æ˜¯å¦æœ‰åŠ æ™‚é–“æˆ³è¨˜ï¼š<span class="code">?v=1732694400000</span></li>
        <li>æŒ‰ <span class="code">Ctrl + Shift + R</span> å¼·åˆ¶é‡æ–°æ•´ç†</li>
        <li>F12 é–‹ç™¼è€…å·¥å…·è¨­å®šåœç”¨å¿«å–</li>
      </ol>
    </div>
  </div>

  <!-- å¼•å…¥ ThemeLoaderï¼ˆå¦‚æœå­˜åœ¨ï¼‰-->
  <script src="../core/theme-loader.js"></script>

  <script>
    let loader = null;

    // åˆå§‹åŒ– ThemeLoader
    try {
      loader = new ThemeLoader();
      loader.setCacheMode(false); // é è¨­é–‹ç™¼æ¨¡å¼
      document.getElementById('enableCache').checked = false;
    } catch (e) {
      console.log('ThemeLoader å°šæœªè¼‰å…¥ï¼ˆé€™æ˜¯æ­£å¸¸çš„ï¼Œå¦‚æœæ˜¯å–®ç¨æ¸¬è©¦ï¼‰');
    }

    // æ›´æ–°å¿«å–æ¨¡å¼
    function updateCacheMode() {
      if (loader) {
        const enabled = document.getElementById('enableCache').checked;
        loader.setCacheMode(enabled);
      }
    }

    // æ¸¬è©¦ 1ï¼šåŸºæœ¬è¼‰å…¥æ¸¬è©¦
    async function testBasicLoad() {
      const resultDiv = document.getElementById('basic-result');
      resultDiv.innerHTML = '<div class="status info">ğŸ”„ æ¸¬è©¦ä¸­...</div>';

      const timestamp = new Date().getTime();
      const testUrl = `themes/wave-harmonics/questions-v2.json?v=${timestamp}`;

      try {
        const startTime = performance.now();
        const response = await fetch(testUrl);
        const endTime = performance.now();
        const loadTime = (endTime - startTime).toFixed(2);

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        
        // å–å¾—å¿«å–è³‡è¨Šï¼ˆéœ€è¦å¾ Performance APIï¼‰
        const perfEntries = performance.getEntriesByName(testUrl);
        const cacheInfo = perfEntries.length > 0 ? 
          (perfEntries[0].transferSize === 0 ? 'from cache' : 'from server') : 
          'unknown';

        resultDiv.innerHTML = `
          <div class="status success">âœ… è¼‰å…¥æˆåŠŸ</div>
          <table>
            <tr>
              <th>é …ç›®</th>
              <th>çµæœ</th>
            </tr>
            <tr>
              <td>æª”æ¡ˆç¶²å€</td>
              <td>${testUrl}</td>
            </tr>
            <tr>
              <td>ç‹€æ…‹ç¢¼</td>
              <td>${response.status} ${response.statusText}</td>
            </tr>
            <tr>
              <td>è¼‰å…¥æ™‚é–“</td>
              <td>${loadTime} ms</td>
            </tr>
            <tr>
              <td>å¿«å–ç‹€æ…‹</td>
              <td><span class="cache-indicator ${cacheInfo === 'from cache' ? 'from-cache' : 'from-server'}">${cacheInfo}</span></td>
            </tr>
            <tr>
              <td>æ™‚é–“æˆ³è¨˜</td>
              <td>${timestamp}</td>
            </tr>
            <tr>
              <td>é¡Œç›®é›†æ•¸é‡</td>
              <td>${Object.keys(data.questionSets || {}).length} å€‹</td>
            </tr>
          </table>
          <div class="info-box">
            ${cacheInfo === 'from cache' ? 
              'âš ï¸ è­¦å‘Šï¼šæª”æ¡ˆå¾å¿«å–è¼‰å…¥ï¼å»ºè­°ä½¿ç”¨ Ctrl+Shift+R å¼·åˆ¶é‡æ–°æ•´ç†' : 
              'âœ… æ­£å¸¸ï¼šæª”æ¡ˆå¾ä¼ºæœå™¨è¼‰å…¥'}
          </div>
        `;

      } catch (error) {
        resultDiv.innerHTML = `
          <div class="status error">âŒ è¼‰å…¥å¤±æ•—</div>
          <div class="result">éŒ¯èª¤è¨Šæ¯ï¼š${error.message}</div>
          <div class="info-box">
            <strong>å¯èƒ½åŸå› ï¼š</strong><br>
            1. æª”æ¡ˆè·¯å¾‘éŒ¯èª¤<br>
            2. æœ¬åœ°ä¼ºæœå™¨æ²’æœ‰å•Ÿå‹•<br>
            3. æª”æ¡ˆä¸å­˜åœ¨<br>
            <br>
            <strong>è§£æ±ºæ–¹æ³•ï¼š</strong><br>
            1. ç¢ºèªåœ¨æ­£ç¢ºç›®éŒ„åŸ·è¡Œæ¸¬è©¦<br>
            2. ç¢ºèªå·²å•Ÿå‹•ä¼ºæœå™¨ï¼ˆpython -m http.server 8000ï¼‰<br>
            3. æª¢æŸ¥ themes/wave-harmonics/questions-v2.json æ˜¯å¦å­˜åœ¨
          </div>
        `;
      }
    }

    // æ¸¬è©¦ 2ï¼šThemeLoader æ¸¬è©¦
    async function testThemeLoader() {
      const resultDiv = document.getElementById('loader-result');
      
      if (!loader) {
        resultDiv.innerHTML = `
          <div class="status error">âŒ ThemeLoader æœªè¼‰å…¥</div>
          <div class="info-box">
            è«‹ç¢ºèª theme-loader.js åœ¨æ­£ç¢ºä½ç½®ï¼š<br>
            <span class="code">../core/theme-loader.js</span>
          </div>
        `;
        return;
      }

      resultDiv.innerHTML = '<div class="status info">ğŸ”„ æ¸¬è©¦ä¸­...</div>';

      try {
        const startTime = performance.now();
        const theme = await loader.loadTheme('wave-harmonics');
        const endTime = performance.now();
        const loadTime = (endTime - startTime).toFixed(2);

        const cacheMode = loader.enableCache ? 'å•Ÿç”¨ï¼ˆç™¼å¸ƒæ¨¡å¼ï¼‰' : 'åœç”¨ï¼ˆé–‹ç™¼æ¨¡å¼ï¼‰';

        resultDiv.innerHTML = `
          <div class="status success">âœ… ThemeLoader æ¸¬è©¦æˆåŠŸ</div>
          <table>
            <tr>
              <th>é …ç›®</th>
              <th>çµæœ</th>
            </tr>
            <tr>
              <td>ä¸»é¡Œåç¨±</td>
              <td>${theme.name}</td>
            </tr>
            <tr>
              <td>ä¸»é¡Œç‰ˆæœ¬</td>
              <td>${theme.theme.metadata.version}</td>
            </tr>
            <tr>
              <td>è¼‰å…¥æ™‚é–“</td>
              <td>${loadTime} ms</td>
            </tr>
            <tr>
              <td>å¿«å–æ¨¡å¼</td>
              <td><strong>${cacheMode}</strong></td>
            </tr>
            <tr>
              <td>é—œå¡æ•¸é‡</td>
              <td>${theme.config.levels.length} å€‹</td>
            </tr>
            <tr>
              <td>é¡Œç›®é›†æ•¸é‡</td>
              <td>${Object.keys(theme.questions.questionSets).length} å€‹</td>
            </tr>
          </table>
          <div class="info-box">
            ${loader.enableCache ? 
              'âš ï¸ ç›®å‰ç‚ºç™¼å¸ƒæ¨¡å¼ï¼Œæª”æ¡ˆæœƒè¢«å¿«å–' : 
              'âœ… ç›®å‰ç‚ºé–‹ç™¼æ¨¡å¼ï¼Œæ¯æ¬¡éƒ½é‡æ–°è¼‰å…¥'}
          </div>
        `;

      } catch (error) {
        resultDiv.innerHTML = `
          <div class="status error">âŒ è¼‰å…¥å¤±æ•—</div>
          <div class="result">${error.message}</div>
        `;
      }
    }

    // æ¸¬è©¦ 3ï¼šå¤šæ¬¡è¼‰å…¥æ¯”è¼ƒ
    async function testMultipleLoads() {
      const resultDiv = document.getElementById('multiple-result');
      resultDiv.innerHTML = '<div class="status info">ğŸ”„ æ¸¬è©¦ä¸­...</div>';

      const results = [];
      const testCount = 5;

      for (let i = 0; i < testCount; i++) {
        const timestamp = new Date().getTime();
        const testUrl = `themes/wave-harmonics/questions-v2.json?v=${timestamp}`;
        
        try {
          const startTime = performance.now();
          const response = await fetch(testUrl);
          const endTime = performance.now();
          const loadTime = (endTime - startTime).toFixed(2);

          const perfEntries = performance.getEntriesByName(testUrl);
          const cacheInfo = perfEntries.length > 0 ? 
            (perfEntries[0].transferSize === 0 ? 'cache' : 'server') : 
            'unknown';

          results.push({
            round: i + 1,
            status: response.status,
            loadTime: loadTime,
            cacheInfo: cacheInfo,
            timestamp: timestamp
          });

        } catch (error) {
          results.push({
            round: i + 1,
            status: 'Error',
            loadTime: '0',
            cacheInfo: 'error',
            timestamp: timestamp
          });
        }

        // çŸ­æš«å»¶é²é¿å…å¤ªå¿«
        await new Promise(resolve => setTimeout(resolve, 100));
      }

      // é¡¯ç¤ºçµæœ
      let tableHtml = `
        <div class="status success">âœ… æ¸¬è©¦å®Œæˆï¼ˆ${testCount} æ¬¡ï¼‰</div>
        <table>
          <tr>
            <th>æ¬¡æ•¸</th>
            <th>ç‹€æ…‹ç¢¼</th>
            <th>è¼‰å…¥æ™‚é–“</th>
            <th>ä¾†æº</th>
            <th>æ™‚é–“æˆ³è¨˜</th>
          </tr>
      `;

      results.forEach(r => {
        tableHtml += `
          <tr>
            <td>${r.round}</td>
            <td>${r.status}</td>
            <td>${r.loadTime} ms</td>
            <td><span class="cache-indicator ${r.cacheInfo === 'cache' ? 'from-cache' : 'from-server'}">${r.cacheInfo}</span></td>
            <td>${r.timestamp}</td>
          </tr>
        `;
      });

      tableHtml += '</table>';

      // åˆ†æçµæœ
      const fromServer = results.filter(r => r.cacheInfo === 'server').length;
      const fromCache = results.filter(r => r.cacheInfo === 'cache').length;

      tableHtml += `
        <div class="info-box">
          <strong>åˆ†æçµæœï¼š</strong><br>
          å¾ä¼ºæœå™¨è¼‰å…¥ï¼š${fromServer} æ¬¡<br>
          å¾å¿«å–è¼‰å…¥ï¼š${fromCache} æ¬¡<br>
          <br>
          ${fromCache === 0 ? 
            'âœ… å®Œç¾ï¼æ‰€æœ‰è«‹æ±‚éƒ½å¾ä¼ºæœå™¨è¼‰å…¥ï¼Œé˜²å¿«å–åŠŸèƒ½æ­£å¸¸' : 
            `âš ï¸ è­¦å‘Šï¼šæœ‰ ${fromCache} æ¬¡å¾å¿«å–è¼‰å…¥ï¼Œå»ºè­°æª¢æŸ¥è¨­å®š`}
        </div>
      `;

      resultDiv.innerHTML = tableHtml;
    }

    // æ¸…é™¤çµæœ
    function clearResults() {
      document.getElementById('basic-result').innerHTML = '';
      document.getElementById('loader-result').innerHTML = '';
      document.getElementById('multiple-result').innerHTML = '';
      performance.clearResourceTimings();
    }

    // é é¢è¼‰å…¥æ™‚é¡¯ç¤ºæç¤º
    window.addEventListener('load', () => {
      console.log('ğŸ” å¿«å–æ¸¬è©¦å·¥å…·å·²è¼‰å…¥');
      console.log('ğŸ“ ä½¿ç”¨èªªæ˜ï¼š');
      console.log('1. é»æ“Šã€Œæ¸¬è©¦ 1ã€æª¢æŸ¥åŸºæœ¬è¼‰å…¥');
      console.log('2. é»æ“Šã€Œæ¸¬è©¦ 2ã€æ¸¬è©¦ ThemeLoader');
      console.log('3. é»æ“Šã€Œæ¸¬è©¦ 3ã€é€²è¡Œå¤šæ¬¡è¼‰å…¥æ¯”è¼ƒ');
      console.log('4. è¨˜å¾—æŒ‰ F12 æ‰“é–‹é–‹ç™¼è€…å·¥å…·æŸ¥çœ‹ Network æ¨™ç±¤');
    });
  </script>
</body>
</html>
